node ('master'){
  env.WORKSPACE = pwd()
  echo "${env.WORKSPACE}"

  stage 'Build'
  checkout scm
  sh 'uptime'

  stage 'Live'
  sh 'echo "promote Live"'

  withDockerContainer(args: "--privileged -u root --volume ${env.WORKSPACE}:/code:rw,Z", image: 'centos:6') {
    sh 'ls -la /code'
    sh 'yum install -y ruby rubygems httpd'
    sh 'curl -sSL https://rvm.io/mpapis.asc | gpg2 --import -'
    sh 'curl -L get.rvm.io | bash -s stable'
    sh 'source /etc/profile.d/rvm.sh; rvm reload; rvm install 2.1.0; rvm use 2.1.0 --default'
    sh 'source /etc/profile.d/rvm.sh; gem install serverspec'
    sh 'source /etc/profile.d/rvm.sh; gem install rake'
    sh 'service start httpd'
    sh 'chkconfig enable httpd'
    sh 'cd /code; source /etc/profile.d/rvm.sh; rvm use 2.1.0; rake spec'
  }

  stage 'Unstable'
  sh 'echo "promote Unstable"'

  stage 'Testing'
  sh 'echo "promote Testing"'

  timeout(time: 300, unit: 'SECONDS') {
    input message: 'Waiting for approve', ok: 'Approve'
    stage 'Stable'
    sh 'echo "promote Stable"'
  }

}
